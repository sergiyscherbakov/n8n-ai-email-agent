# AI Email Processing Agent для n8n

Цей проект містить готовий workflow для автоматичної обробки електронної пошти за допомогою AI агента в n8n.

## Опис

Workflow автоматично:
- отримує вхідні листи з Gmail
- аналізує їх за допомогою мовної моделі (OpenAI GPT)
- генерує відповіді на основі контексту
- створює чернетки відповідей у Gmail
- зберігає результати у Google Sheets для подальшого аналізу

## Схема Workflow

Workflow складається з двох варіантів реалізації:

### Варіант 1: Послідовна обробка (Simple Flow)
```
Gmail Trigger → AI Agent → Create Draft → Append to Sheet
                    ↑
                    |
      ┌─────────────┴──────────────┐
      |                            |
OpenAI Chat Model          Simple Memory
                                   |
                     Structured Output Parser
```

### Варіант 2: Агентна обробка (Advanced Flow)
```
Gmail Trigger → AI Agent → (завершення)
                    ↑
                    |
      ┌─────────────┴──────────────┬──────────────────┬────────────────────┐
      |                            |                  |                    |
OpenAI Chat Model          Simple Memory    Gmail Tool         Google Sheets Tool
                                   |
                     Structured Output Parser
```

## Детальний опис нод

### 1. Gmail Trigger (Тригер)

**Призначення:** Автоматично відслідковує нові листи у Gmail

**Параметри для налаштування:**
- **Gmail Account**: Підключіть свій Gmail акаунт через OAuth2
- **Poll Times**: Час перевірки пошти (за замовчуванням: щодня о 20:00)
- **Filters**: Додаткові фільтри для вхідних листів (за бажанням)

**Вхід:** Немає (це тригер)

**Вихід:**
```json
{
  "From": "sender@example.com",
  "Subject": "Тема листа",
  "snippet": "Перші 200 символів повідомлення...",
  "threadId": "abc123xyz",
  "messageId": "msg-001"
}
```

---

### 2. AI Agent (Головний агент)

**Призначення:** Аналізує лист і генерує структуровану відповідь

**Параметри для налаштування:**

**Prompt Type:** `define`

**User Message Template:**
```
Тема повідомлення: {{ $json.Subject }}
Текст повідомлення: {{ $json.snippet }}
```

**System Message:**
```
Ти - Сергій Щербаков  відповідаєш на запитання, які тобі приходять на пошту.
Користувач надає тобі Тему та Текст Повідомлення на яке треба дати відповідь.
Виконай наступні дії:
1. Проаналізуй повідомлення і надай на нього прямолінійну відповідь
2. Відповідай в дакадемічному безособовому стилі

Відповідай мовою, яка написана в Текст повідомлення

Відповідь надай в валідному форматі JSON який має наступну структуру:
{
  "topic": "Приклад теми",
  "message_draft": "Чернетка повідомлення, яку можна буде відредагувати та надіслати."
}
```

**Що змінити:**
- Замініть "Сергій Щербаков" та опис персонажа на свої дані
- Налаштуйте стиль відповідей під свої потреби
- За бажанням додайте додаткові інструкції

**Вхід:**
```json
{
  "Subject": "string",
  "snippet": "string"
}
```

**Вихід:**
```json
{
  "output": {
    "topic": "Re: Тема відповіді",
    "message_draft": "Згенерований текст відповіді"
  }
}
```

---

### 3. OpenAI Chat Model

**Призначення:** Надає доступ до мовної моделі OpenAI

**Параметри для налаштування:**
- **Connection**: Додайте OpenAI API ключ в Credentials
- **Model**: Оберіть модель (за замовчуванням: `gpt-4` або `gpt-3.5-turbo`)

**Як отримати API ключ:**
1. Зареєструйтесь на https://platform.openai.com/
2. Перейдіть до API Keys
3. Створіть новий ключ
4. Скопіюйте його в n8n Credentials

**Вхід:** Під'єднується до AI Agent через AI connection

**Вихід:** Результати обробки моделлю

---

### 4. Simple Memory (Window Buffer Memory)

**Призначення:** Зберігає контекст розмови для послідовних повідомлень

**Параметри для налаштування:**
- **Session ID Type**: `customKey`
- **Session Key**: `{{ $json.threadId }}` - використовує ID треду Gmail для збереження контексту
- **Context Window Length**: `50` - кількість повідомлень в історії

**Що це дає:**
- Агент пам'ятає попередні листи в одному треді
- Може продовжувати розмову з контекстом
- Кожен тред має окрему пам'ять

**Вхід:** Під'єднується до AI Agent

**Вихід:** Історія розмови для AI Agent

---

### 5. Structured Output Parser

**Призначення:** Забезпечує структурований JSON вихід від AI

**Параметри для налаштування:**

**JSON Schema:**
```json
{
  "topic": "Приклад теми",
  "message_draft": "Чернетка повідомлення, яку можна буде відредагувати та надіслати."
}
```

**Що це дає:**
- Гарантує, що AI завжди повертає валідний JSON
- Уникає помилок парсингу
- Забезпечує однаковий формат виходу

**Вхід:** Під'єднується до AI Agent

**Вихід:** Парсить відповідь агента в структурований JSON

---

### 6. Create a Draft (Gmail)

**Призначення:** Створює чернетку відповіді в Gmail

**Параметри для налаштування:**
- **Resource**: `draft`
- **Subject**: `{{ $json.output.topic }}` - тема з AI відповіді
- **Message**: `{{ $json.output.message_draft }}` - текст з AI відповіді

**Options:**
- **Reply To**: `{{ $('Gmail Trigger').item.json.From }}` - відповідь на email відправника
- **Thread ID**: `{{ $('Gmail Trigger').item.json.threadId }}` - додає до існуючого треду
- **Send To**: `{{ $('Gmail Trigger').item.json.From }}` - email отримувача

**Вхід:**
```json
{
  "output": {
    "topic": "string",
    "message_draft": "string"
  }
}
```

**Вихід:**
```json
{
  "draftId": "draft-001",
  "message": "Draft created successfully"
}
```

---

### 7. Append Row in Sheet (Google Sheets)

**Призначення:** Зберігає інформацію про оброблені листи

**Параметри для налаштування:**
- **Operation**: `append`
- **Document ID**: Ваш Google Sheet ID (знайдіть в URL таблиці)
- **Sheet Name**: Назва аркушу (за замовчуванням: перший аркуш)

**Columns Mapping:**
```javascript
{
  "to": "{{ $('Gmail Trigger').item.json.From }}",      // Email відправника
  "draft": "{{ $('AI Agent').item.json.output.message_draft }}"  // Згенерована відповідь
}
```

**Як знайти Sheet ID:**
URL таблиці виглядає так:
```
https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit
```

**Структура таблиці:**
| to | draft |
|------|-------|
| sender@example.com | Текст відповіді |

**Вхід:**
```json
{
  "to": "string",
  "draft": "string"
}
```

**Вихід:**
```json
{
  "success": true,
  "row": 5
}
```

---

## Інструкція з налаштування

### Крок 1: Імпорт Workflow

1. Завантажте файл `My Agent Personal-3.json`
2. Відкрийте n8n
3. Перейдіть до **Workflows** → **Import from File**
4. Оберіть завантажений JSON файл

### Крок 2: Налаштування Gmail Trigger

1. Клікніть на ноду **Gmail Trigger**
2. Натисніть **Connect Account**
3. Увійдіть через свій Gmail акаунт
4. Дозвольте доступ до читання пошти
5. (Опціонально) Налаштуйте час перевірки в **Poll Times**

### Крок 3: Налаштування OpenAI

1. Клікніть на ноду **OpenAI Chat Model**
2. Натисніть **Create New Credential**
3. Вставте ваш OpenAI API ключ
4. Оберіть модель (рекомендується `gpt-4` або `gpt-3.5-turbo`)
5. Збережіть

### Крок 4: Налаштування AI Agent

1. Клікніть на ноду **AI Agent**
2. В **System Message** замініть:
   - Ім'я та опис персонажа
   - Стиль відповідей
3. Перевірте що **User Message Template** містить:
   ```
   Тема повідомлення: {{ $json.Subject }}
   Текст повідомлення: {{ $json.snippet }}
   ```

### Крок 5: Налаштування Google Sheets

1. Створіть нову таблицю в Google Sheets
2. Додайте заголовки: `to` | `draft`
3. Скопіюйте Sheet ID з URL
4. Клікніть на ноду **Append row in sheet**
5. Натисніть **Connect Account** → увійдіть через Google
6. Вставте ваш Sheet ID в **Document ID**
7. Оберіть аркуш в **Sheet Name**

### Крок 6: Налаштування Create a Draft

1. Клікніть на ноду **Create a Draft**
2. Використайте той же Gmail акаунт що і для Trigger
3. Дозвольте доступ до створення чернеток

---

## Як перевірити Workflow

### Тестовий запуск

1. Натисніть кнопку **Execute Workflow** в правому верхньому куті
2. Надішліть тестовий лист на ваш Gmail (з іншого акаунта)
3. Почекайте на виконання або запустіть вручну через **Execute Workflow**

### Що перевірити:

**✅ Gmail Trigger:**
- Отримав лист
- Виділив Subject та snippet
- Передав threadId

**✅ AI Agent:**
- Проаналізував лист
- Згенерував відповідь правильною мовою
- Повернув валідний JSON з topic та message_draft

**✅ Create a Draft:**
- Створена чернетка в Gmail → Drafts
- Чернетка в правильному треді
- Reply to налаштований на відправника

**✅ Google Sheets:**
- З'явився новий рядок
- Email відправника в колонці "to"
- Згенерована відповідь в колонці "draft"

### Перегляд результатів

1. **В n8n:** Клікніть на кожну ноду щоб побачити INPUT/OUTPUT дані
2. **В Gmail:** Перейдіть до Drafts → знайдіть чернетку
3. **В Google Sheets:** Відкрийте таблицю → перевірте новий рядок

---

## Активація Workflow

Після успішного тестування:

1. Натисніть перемикач **Inactive → Active** вгорі
2. Workflow буде автоматично запускатись за розкладом
3. Для зупинки: натисніть **Active → Inactive**

---

## Різниця між Варіантом 1 і Варіантом 2

### Варіант 1 (Simple Flow - ноди 1-6)

**Підхід:** Послідовна обробка
- AI Agent генерує JSON
- Окремі ноди створюють draft і записують в Sheets
- Простіша логіка, легше налаштувати

**Використовуйте коли:**
- Вам потрібна проста обробка пошти
- Не потрібна складна логіка
- Ви хочете більше контролю над кожним кроком

### Варіант 2 (Advanced Flow - ноди 7-12)

**Підхід:** Агентна обробка з Tools
- AI Agent сам вирішує коли і що робити
- Gmail і Sheets під'єднані як Tools до агента
- Більш гнучка поведінка

**Використовуйте коли:**
- Потрібна динамічна логіка (не завжди створювати draft)
- AI має вирішувати що робити
- Потрібна складніша обробка

---

## Типові помилки та рішення

### Помилка: "Authentication required"
**Рішення:** Перепідключіть Gmail/Google Sheets акаунти

### Помилка: "OpenAI API key invalid"
**Рішення:** Перевірте ключ на https://platform.openai.com/api-keys

### Помилка: "JSON parse error"
**Рішення:** Перевірте що Structured Output Parser правильно налаштований

### Draft не створюється в правильному треді
**Рішення:** Перевірте що Thread ID передається: `{{ $('Gmail Trigger').item.json.threadId }}`

### Дублюються записи в Sheets
**Рішення:** Перевірте налаштування Poll Times - можливо занадто часто перевіряє

---

## Розширення можливостей

### Додати класифікацію листів
В System Message додайте:
```
3. Визнач категорію листа: "запитання" / "скарга" / "пропозиція"
```
В JSON Schema:
```json
{
  "topic": "...",
  "message_draft": "...",
  "category": "запитання"
}
```

### Додати автовідправку
Замість "Create a Draft" використайте ноду **Gmail → Send Message**

⚠️ **Увага:** Перевірте workflow ретельно перед автовідправкою!

### Додати Telegram сповіщення
Після AI Agent додайте ноду **Telegram → Send Message** для отримання сповіщень про нові листи

---

## Ліцензія

Цей проект доступний для вільного використання та модифікації.

## Підтримка

Якщо виникли питання:
1. Перевірте налаштування кожної ноди
2. Подивіться логи виконання в n8n
3. Перегляньте документацію n8n: https://docs.n8n.io/
